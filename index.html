<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Vista 3D Studio</title>
    <style>
        body, html { margin: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #111; color: white; }
        .menu-bar { height: 35px; display: flex; background: #cecece; align-items: center; padding: 0 10px; border-bottom: 1px solid #000; gap: 10px; color: black; }
        #main-layout { display: flex; height: calc(100% - 35px); }
        .toolbar { width: 75px; display: flex; flex-direction: column; gap: 10px; padding: 10px; border-right: 1px solid #444; background: #222; }
        .inspector { width: 320px; padding: 15px; border-left: 1px solid #444; background: #222; overflow-y: auto; }
        #viewport { flex-grow: 1; position: relative; outline: none; }
        .btn { padding: 8px; cursor: pointer; background: #444; color: white; border: 1px solid #666; font-size: 10px; font-weight: bold; text-align: center; border-radius: 3px; }
        .play-btn { background: #2e7d32; padding: 5px 20px; font-size: 12px; }
        .play-btn.playing { background: #c62828; }
        .export-btn { background: #673ab7; color: white; margin-left: auto; }
        .add-block-btn { background: #0078d7; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 18px; line-height: 0; }
        textarea { width: 93%; height: 250px; background: #000; color: #0f0; font-family: 'Consolas', monospace; padding: 10px; border: 1px solid #555; font-size: 13px; resize: none; outline: none; }
        .dropdown-content { display: none; position: absolute; right: 0; background: #333; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 100; border: 1px solid #555; }
        .dropdown-content div { color: white; padding: 8px 12px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #444; }
        .dropdown-content div:hover { background: #444; }
        .show { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
<nav class="menu-bar">
    <b style="font-size: 11px;">VISTA 3D STUDIO</b>
    <div class="btn" onclick="addObj('cube')">+ CUBO</div>
    <div class="btn" onclick="addObj('sphere')">+ BOLA</div>
    <button id="btn-play" class="play-btn btn" onclick="togglePlayMode()">‚ñ∂ PLAY</button>
    <button class="btn export-btn" onclick="exportToExe()">üíæ EXPORTAR EXE</button>
</nav>
<div id="main-layout">
    <aside class="toolbar">
        <div class="btn" onclick="setMode('translate')">MOVER</div>
        <div class="btn" onclick="setMode('rotate')">ROTAR</div>
        <div class="btn" onclick="setMode('scale')">ESCALAR</div>
        <hr style="width:100%; border:0; border-top:1px solid #555;">
        <div class="btn" style="color:#ff5555;" onclick="deleteObj()">BORRAR</div>
    </aside>
    <div id="viewport" tabindex="1"></div>
    <aside class="inspector">
        <div id="inspector-ui" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <h3>Scripts 3D</h3>
                <div style="position:relative">
                    <button class="add-block-btn" onclick="toggleBlocks()">+</button>
                    <div id="blockMenu" class="dropdown-content">
                        <div style="background:#222; color:#aaa; padding:5px; font-size:9px;">ESTRUCTURAS</div>
                        <div onclick="insertBlock('Loop\n\nEnd')">üîÑ Loop</div>
                        <div onclick="insertBlock('if key w\n\nend')">‚å®Ô∏è Tecla W</div>
                        <div style="background:#222; color:#aaa; padding:5px; font-size:9px;">MOVIMIENTO</div>
                        <div onclick="insertBlock('move x 0.1')">‚û°Ô∏è Mover X (Derecha)</div>
                        <div onclick="insertBlock('move x -0.1')">‚¨ÖÔ∏è Mover X (Izquierda)</div>
                        <div onclick="insertBlock('move y 0.1')">‚¨ÜÔ∏è Mover Y (Arriba)</div>
                        <div onclick="insertBlock('move y -0.1')">‚¨áÔ∏è Mover Y (Abajo)</div>
                        <div onclick="insertBlock('move z 0.1')">üü¶ Mover Z (Frente)</div>
                        <div onclick="insertBlock('move z -0.1')">‚¨õ Mover Z (Atr√°s)</div>
                        <div style="background:#222; color:#aaa; padding:5px; font-size:9px;">F√çSICAS</div>
                        <div onclick="insertBlock('gravity on')">üçé Gravedad</div>
                        <div onclick="insertBlock('rotate y 0.05')">üîÑ Rotar Y</div>
                    </div>
                </div>
            </div>
            <textarea id="obj-script" spellcheck="false"></textarea>
            <button class="btn" onclick="applyScript()" style="width:100%; margin-top:10px; background:#0078d7; height: 35px;">GUARDAR</button>
        </div>
        <div id="no-select" style="text-align: center; color: #666; margin-top: 50px;">Selecciona un objeto</div>
    </aside>
</div>

<script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } } </script>
<script type="module">
import * as THREE from 'three';
import { TransformControls } from 'three/addons/controls/TransformControls.js';
let scene, camera, renderer, transform, raycaster, mouse, selectedObject = null, isPlaying = false;
const objects = [], keys = {}; window.gameKeys = {};

window.exportToExe = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([document.documentElement.outerHTML], {type:'text/html'})); a.download='juego_3d.html'; a.click(); };
window.toggleBlocks = () => document.getElementById("blockMenu").classList.toggle("show");
window.insertBlock = (t) => { const a = document.getElementById('obj-script'); a.setRangeText(t + "\n", a.selectionStart, a.selectionEnd, 'end'); toggleBlocks(); };

function init() {
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x111111);
    const vp = document.getElementById('viewport');
    camera = new THREE.PerspectiveCamera(75, vp.clientWidth/vp.clientHeight, 0.1, 1000);
    camera.position.set(10, 10, 10); camera.lookAt(0,0,0);
    renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(vp.clientWidth, vp.clientHeight);
    vp.appendChild(renderer.domElement);
    transform = new TransformControls(camera, renderer.domElement); scene.add(transform);
    raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();
    window.addEventListener('keydown', e => { keys[e.code] = true; window.gameKeys[e.key.toLowerCase()] = true; });
    window.addEventListener('keyup', e => { keys[e.code] = false; window.gameKeys[e.key.toLowerCase()] = false; });
    vp.addEventListener('mousedown', e => {
        const r = renderer.domElement.getBoundingClientRect();
        mouse.x = ((e.clientX - r.left) / r.width) * 2 - 1; mouse.y = -((e.clientY - r.top) / r.height) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const ints = raycaster.intersectObjects(objects);
        if (!isPlaying && !transform.dragging) { if (ints.length > 0) select(ints[0].object); else deselect(); }
    });
    scene.add(new THREE.GridHelper(50, 50, 0x444444)); scene.add(new THREE.AmbientLight(0xffffff, 1));
    animate();
}

window.addObj = (type) => {
    const geo = type === 'cube' ? new THREE.BoxGeometry(2,2,2) : new THREE.SphereGeometry(1.2, 32, 32);
    const mesh = new THREE.Mesh(geo, new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff }));
    scene.add(mesh); objects.push(mesh); select(mesh);
};

window.applyScript = () => {
    if(!selectedObject) return;
    let lines = document.getElementById('obj-script').value.toLowerCase().split('\n'), js = "";
    selectedObject.userData.hasGravity = false;
    lines.forEach(l => {
        l = l.trim();
        if(l === "loop") js += "";
        if(l === "gravity on") selectedObject.userData.hasGravity = true;
        else if(l.startsWith("if key")) js += `if(window.gameKeys['${l.split(' ')[2]}']){ `;
        else if(l.startsWith("move")) js += `this.position.${l.split(' ')[1]} += ${parseFloat(l.split(' ')[2])}; `;
        else if(l.startsWith("rotate")) js += `this.rotation.${l.split(' ')[1]} += ${parseFloat(l.split(' ')[2])}; `;
        else if(l === "end") js += "} ";
    });
    selectedObject.userData.compiled = js; selectedObject.userData.raw = document.getElementById('obj-script').value;
};

window.togglePlayMode = () => {
    isPlaying = !isPlaying;
    const btn = document.getElementById('btn-play');
    if(isPlaying) {
        objects.forEach(o => { o.userData.sP = o.position.clone(); o.userData.sR = o.rotation.clone(); o.userData.vel = new THREE.Vector3(0,0,0); });
        btn.innerText = "‚ñ† STOP"; deselect();
    } else {
        objects.forEach(o => { o.position.copy(o.userData.sP); o.rotation.copy(o.userData.sR); });
        btn.innerText = "‚ñ∂ PLAY";
    }
};

function animate() {
    requestAnimationFrame(animate);
    if(isPlaying) {
        objects.forEach(o => {
            if(o.userData.hasGravity) { o.userData.vel.y -= 0.01; o.position.add(o.userData.vel); if(o.position.y < 0) { o.position.y = 0; o.userData.vel.y = 0; } }
            if(o.userData.compiled) { try { new Function(o.userData.compiled).call(o); } catch(e){} }
        });
    }
    renderer.render(scene, camera);
}
window.setMode = (m) => transform.setMode(m);
window.deleteObj = () => { if(selectedObject) { scene.remove(selectedObject); objects.splice(objects.indexOf(selectedObject), 1); deselect(); }};
function select(o) { selectedObject = o; transform.attach(o); document.getElementById('inspector-ui').classList.remove('hidden'); document.getElementById('no-select').classList.add('hidden'); document.getElementById('obj-script').value = o.userData.raw || ""; }
function deselect() { selectedObject = null; transform.detach(); document.getElementById('inspector-ui').classList.add('hidden'); document.getElementById('no-select').classList.remove('hidden'); }
init();
</script>
</body>
</html>
